<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GoldenPond</title>
    <style>
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .control-section {
            margin: 20px 0;
        }

        .line-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .part-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }

        .button-group {
            margin: 10px 0;
        }

        .button-group button {
            padding: 8px 16px;
            margin-right: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 1000px) {
            .line-controls-grid {
                grid-template-columns: 1fr;
            }
        }

        .line-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .preview-column {
            background: white;
            padding: 10px;
            border-radius: 3px;
        }

        .piano-roll-preview {
            width: 300px;
            height: 150px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .slider-group {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
    </style>
    <link rel="stylesheet" href="styles.css">
    
    <!-- First load Soundfont player -->
    <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
    
    <!-- Then load goldenpond -->
    <script src="./goldenpond.js"></script>

    <!-- Then load MIDI file writer -->
    <script src="./midi-file.js"></script>

    <!-- Add this after the other script tags in the head section -->
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
</head>
<body>
  <div class="container">
    <h2>GoldenPond</h2>

    <!-- Root and Mode Section -->
    <div class="control-section">
        <div class="control-group">
            <label for="root">Root:</label>
            <input type="range" id="root" name="root" min="32" max="96" value="65">
            <span id="rootValue">65</span>
        </div>
        <div class="control-group">
            <label for="mode">Mode:</label>
            <select id="mode">
                <option value="0">Major</option>
                <option value="1">Minor</option>
            </select>
        </div>
    </div>

    <!-- Chord Sequence -->
    <div class="control-section">
        <label for="chordSequence">Chord Sequence:</label><br>
        <textarea id="chordSequence" rows="4" cols="50">71,76,72,-75,71,76,72,-75i,77,73,76,&lt;12,77ii,&gt;12,71,96,74ii,75</textarea>
    </div>

    <!-- Note Length, Chord Length -->
    <div class="control-section">
        <div class="control-group">
            <label for="noteProportion">Note Length:</label>
            <input type="range" id="noteProportion" name="noteProportion" min="0.1" max="1.5" step="0.1" value="0.8">
            <span id="noteProportionValue">0.8</span>
        </div>
        <div class="control-group">
            <label for="chordLength">Chord Length:</label>
            <input type="range" id="chordLength" name="chordLength" min="1" max="16" value="8">
            <span id="chordLengthValue">8</span>
        </div>
    </div>

    <!-- Add BPM control and play buttons -->
    <div class="control-section">
        <div class="control-group">
            <label for="bpm">Tempo (BPM):</label>
            <input type="range" id="bpm" name="bpm" min="40" max="200" value="120">
            <span id="bpmValue">120</span>
        </div>
        <div class="button-group">
            <button onclick="play()">Play</button>
            <button onclick="stop()">Stop</button>
            <button onclick="downloadMidi()">Download MIDI</button>
        </div>
    </div>

    <!-- Generate Types Section -->
    <div class="control-section">
        <h3>Generate Types:</h3>
        <div id="line-controls"></div>
    </div>

    <br>
  </div>
<script>
    console.log('Start of main script, goldenpond =', typeof goldenpond);
    
    // Global variables
    let domLoaded = false;
    let instrumentsLoaded = false;
    let tm = null;
    let prog = null;
    let audioContext = null;
    let chord_instrument, arp_instrument, bass_instrument, top_instrument, random_instrument;
    let currentLines = [];
    let currentTimeManipulator = null;
    let currentProgression = null;
    let instruments = {};

    // Function to initialize audio after user gesture
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            tm = new TimeManipulator();
            loadInstruments();
        }
    }

    // Add loading indicator
    function showLoading(show) {
        document.querySelectorAll('button').forEach(button => {
            button.disabled = show;
        });
        if (show) {
            document.querySelector('.button-group').insertAdjacentHTML('beforeend', 
                '<span id="loading-text"> Loading sounds...</span>');
        } else {
            document.getElementById('loading-text')?.remove();
        }
    }

    // Function to create all line controls
    function createAllLineControls() {
        const container = document.getElementById('line-controls');
        lineTypes.forEach(lineType => {
            const controls = createLineControls(lineType);
            container.appendChild(controls);
        });
    }

    // Add this function before createAllLineControls
    function createLineControls(lineType) {
        const section = document.createElement('div');
        section.className = 'line-controls';

        // Controls column
        const controlsColumn = document.createElement('div');
        controlsColumn.className = 'controls-column';

        // Active checkbox
        const activeLabel = document.createElement('label');
        const activeCheckbox = document.createElement('input');
        activeCheckbox.type = 'checkbox';
        activeCheckbox.id = `${lineType.id}-active`;
        activeCheckbox.checked = lineType.checked;
        activeLabel.appendChild(activeCheckbox);
        activeLabel.appendChild(document.createTextNode(` ${lineType.name}`));
        controlsColumn.appendChild(activeLabel);

        // Density dropdown
        const densityLabel = document.createElement('label');
        densityLabel.textContent = 'Density:';
        const densitySelect = document.createElement('select');
        densitySelect.id = `${lineType.id}-density`;
        MenuHelper.getRhythmicDensityNames().forEach((name, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.text = name;
            densitySelect.appendChild(option);
        });
        densitySelect.value = "4"; // Default to quarter notes
        controlsColumn.appendChild(densityLabel);
        controlsColumn.appendChild(densitySelect);

        // K and N sliders
        ['k', 'n'].forEach(param => {
            const sliderContainer = document.createElement('div');
            sliderContainer.className = 'slider-group';
            
            const sliderLabel = document.createElement('div');
            sliderLabel.className = 'slider-label';
            sliderLabel.innerHTML = `${param.toUpperCase()}: <span id="${lineType.id}-${param}-value">${lineType[`default${param.toUpperCase()}`]}</span>`;
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = `${lineType.id}-${param}`;
            slider.min = '1';
            slider.max = '24';
            slider.value = lineType[`default${param.toUpperCase()}`];
            
            slider.oninput = () => {
                document.getElementById(`${lineType.id}-${param}-value`).textContent = slider.value;
                updateControls();
            };
            
            sliderContainer.appendChild(sliderLabel);
            sliderContainer.appendChild(slider);
            controlsColumn.appendChild(sliderContainer);
        });

        // Preview column
        const previewColumn = document.createElement('div');
        previewColumn.className = 'preview-column';
        
        const previewTitle = document.createElement('div');
        previewTitle.textContent = 'Preview';
        previewColumn.appendChild(previewTitle);

        const pianoRoll = document.createElement('div');
        pianoRoll.id = `${lineType.id}-preview`;
        pianoRoll.className = 'piano-roll-preview';
        pianoRoll.style.width = '300px';  // Explicit width
        pianoRoll.style.height = '150px'; // Explicit height
        previewColumn.appendChild(pianoRoll);

        // Add event listeners
        activeCheckbox.addEventListener('change', updateControls);
        densitySelect.addEventListener('change', updateControls);

        // Combine columns
        section.appendChild(controlsColumn);
        section.appendChild(previewColumn);

        return section;
    }

    // Load the instruments asynchronously
    function loadInstruments() {
        showLoading(true);
        Promise.all([
            Soundfont.instrument(audioContext, 'acoustic_grand_piano'),
            Soundfont.instrument(audioContext, 'orchestral_harp'),
            Soundfont.instrument(audioContext, 'acoustic_bass'),
            Soundfont.instrument(audioContext, 'flute'),
            Soundfont.instrument(audioContext, 'marimba')
        ]).then(([piano, harp, bass, flute, marimba]) => {
            instruments = {
                'chords': piano,
                'arpeggio': harp,
                'bass': bass,
                'top': flute,
                'random': marimba
            };
            instrumentsLoaded = true;
            showLoading(false);
        }).catch(err => {
            console.error('Error loading instruments:', err);
            showLoading(false);
        });
    }

    // Configuration for each line type
    const lineTypes = [
        {
            id: 'chords',
            name: 'Chords',
            defaultK: 2,
            defaultN: 4,
            checked: true
        },
        {
            id: 'arpeggio',
            name: 'Arpeggio',
            defaultK: 2,
            defaultN: 4,
            checked: false
        },
        {
            id: 'bass',
            name: 'Bass',
            defaultK: 2,
            defaultN: 4,
            checked: false
        },
        {
            id: 'top',
            name: 'Top',
            defaultK: 2,
            defaultN: 4,
            checked: false
        },
        {
            id: 'random',
            name: 'Random',
            defaultK: 2,
            defaultN: 4,
            checked: false
        }
    ];

    // Function to update time and progression settings
    function updateTimeAndProgression() {
        if (!tm) return;
        
        const bpm = parseInt(document.getElementById('bpm').value);
        const beatsPerChord = parseInt(document.getElementById('chordLength').value);
        const root = parseInt(document.getElementById('root').value);
        const mode = document.getElementById('mode').value == "0" ? 
            Mode.getMajorMode() : 
            Mode.getMinorMode();
        const chordSequence = document.getElementById('chordSequence').value;
        
        // Update TimeManipulator
        tm.setPPQ(96)
          .setChordDuration(beatsPerChord)
          .setBPM(bpm);
        
        // Update ChordProgression
        prog = new ChordProgression(root, mode, chordSequence);
        
        console.log('Updated settings:', {
            bpm, beatsPerChord, root, 
            mode: mode == Mode.getMajorMode() ? 'major' : 'minor',
            chordSequence
        });
    }

    // Function to update all music state
    function updateMusicState() {
        const bpm = parseInt(document.getElementById('bpm').value);
        const beatsPerChord = parseInt(document.getElementById('chordLength').value);
        const noteProportion = parseFloat(document.getElementById('noteProportion').value);
        
        // Update time manipulator
        currentTimeManipulator = new TimeManipulator();
        currentTimeManipulator.setPPQ(96)
            .setChordDuration(beatsPerChord)
            .setBPM(bpm);

        // Update progression
        currentProgression = new ChordProgression(
            parseInt(document.getElementById('root').value),
            document.getElementById('mode').value == "0" ? Mode.getMajorMode() : Mode.getMinorMode(),
            document.getElementById('chordSequence').value
        );

        // Update all lines
        currentLines = [];
        lineTypes.forEach(lineType => {
            const values = getLineValues(lineType);
            if (values.active) {
                let line;
                switch(lineType.name) {
                    case 'Chords':
                        line = new ChordLine(currentTimeManipulator, currentProgression, values.k, values.n, noteProportion, values.density);
                        break;
                    case 'Arpeggio':
                        line = new ArpLine(currentTimeManipulator, currentProgression, values.k, values.n, noteProportion, values.density);
                        break;
                    case 'Bass':
                        line = new BassLine(currentTimeManipulator, currentProgression, values.k, values.n, noteProportion, values.density);
                        break;
                    case 'Top':
                        line = new TopLine(currentTimeManipulator, currentProgression, values.k, values.n, noteProportion, values.density);
                        break;
                    case 'Random':
                        line = new RandomLine(currentTimeManipulator, currentProgression, values.k, values.n, noteProportion, values.density);
                        break;
                }
                if (line) {
                    currentLines.push({
                        type: lineType,
                        line: line,
                        notes: line.generateNotes(0, 0, 100)
                    });
                }
            }
        });

        // Update previews
        updatePreviews();
    }

    // Modify updateControls to use the global state
    function updateControls() {
        updateMusicState();
        // Rest of updateControls remains the same
    }

    // Modify play() to use the global state
    function play() {
        if (!audioContext) initAudio();
        
        if (!instrumentsLoaded) {
            console.warn('Instruments not loaded yet');
            return;
        }
        
        const bpm = parseInt(document.getElementById('bpm').value);
        const secondsPerBeat = 60.0 / bpm;
        const baseTime = audioContext.currentTime + 0.1;
        
        console.log('Playing lines:', currentLines.map(l => ({
            type: l.type.id,
            noteCount: l.notes.length,
            hasInstrument: !!instruments[l.type.id]
        })));
        
        currentLines.forEach(({type, notes}) => {
            const instrument = instruments[type.id];
            if (instrument) {
                console.log(`Playing ${type.name} with ${notes.length} notes`);
                notes.forEach(note => {
                    const startInSeconds = (note.startTime / currentTimeManipulator.ppq) * secondsPerBeat;
                    const durationInSeconds = (note.length / currentTimeManipulator.ppq) * secondsPerBeat;
                    instrument.play(note.note, baseTime + startInSeconds, { duration: durationInSeconds });
                });
            } else {
                console.warn(`No instrument found for ${type.name} (id: ${type.id})`);
            }
        });
    }

    // Define instrument mappings
    const INSTRUMENT_PROGRAMS = {
        'chords': 0,    // Acoustic Grand Piano
        'bass': 32,     // Acoustic Bass
        'top': 73,      // Flute
        'arp': 46,      // Harp
        'random': 25    // Acoustic Guitar
    };

    function downloadMidi() {
        console.log('Starting MIDI export with Tone.js...');
        
        // Create a new MIDI file
        const midi = new Midi();
        const bpm = parseInt(document.getElementById('bpm').value);
        const secondsPerBeat = 60.0 / bpm;
        
        midi.header.setTempo(bpm);
        midi.header.timeSignature = [4, 4];
        midi.header.ppq = currentTimeManipulator.ppq;

        // Add tracks for each line
        currentLines.forEach(({type, line}, index) => {
            const track = midi.addTrack();
            
            // Set instrument and channel
            track.channel = index;
            track.instrument.number = INSTRUMENT_PROGRAMS[type.id] || 0;
            
            // Get notes with absolute timing
            const notes = line.generateNotes(0, index, 100);
            
            // Add notes to track
            notes.forEach(note => {
                track.addNote({
                    midi: note.note,
                    time: (note.startTime / currentTimeManipulator.ppq) * secondsPerBeat,
                    duration: (note.length / currentTimeManipulator.ppq) * secondsPerBeat,
                    velocity: note.velocity
                });
            });
        });

        // Convert to MIDI file and download
        const bytes = midi.toArray();
        const blob = new Blob([new Uint8Array(bytes)], { type: 'audio/midi' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'goldenpond.mid';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Modify the DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        domLoaded = true;
        
        try {
            // First create all the controls
            createAllLineControls();
            console.log('Line controls created successfully');
            
            // Add event listeners for global controls
            ['root', 'noteProportion', 'chordLength', 'bpm'].forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Could not find element with id: ${id}`);
                    return;
                }
                element.addEventListener('input', function() {
                    updateDisplayValue(id, `${id}Value`);
                });
            });
            
            // Add handlers for time and progression updates
            ['bpm', 'chordLength', 'root', 'mode', 'chordSequence'].forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Could not find element with id: ${id}`);
                    return;
                }
                element.addEventListener('change', function() {
                    updateTimeAndProgression();
                    updateControls();
                });
            });

            console.log('All event listeners attached successfully');
        } catch (error) {
            console.error('Error during initialization:', error);
        }

        // Initialize audio on first user interaction
        document.body.addEventListener('click', function initOnClick() {
            initAudio();
            document.body.removeEventListener('click', initOnClick);
        });
    });

    // Get values for a line type
    function getLineValues(lineType) {
        return {
            active: document.getElementById(`${lineType.id}-active`).checked,
            density: MenuHelper.rhythmicDensityToNumeric(
                MenuHelper.getRhythmicDensityFor(document.getElementById(`${lineType.id}-density`).value)
            ),
            k: parseInt(document.getElementById(`${lineType.id}-k`).value),
            n: parseInt(document.getElementById(`${lineType.id}-n`).value)
        };
    }

    // Add variable to track scheduled notes
    let scheduledNotes = [];
    
    // Add stop function
    function stop() {
        if (!audioContext) return;
        
        // Stop all active instruments
        Object.values(instruments).forEach(instrument => {
            if (instrument && typeof instrument.stop === 'function') {
                instrument.stop(audioContext.currentTime);
            }
        });
        
        // Clear scheduled notes
        scheduledNotes = [];
    }

    function updateDisplayValue(sliderId, valueId) {
        console.log(`Updating display value: ${sliderId} -> ${valueId}`);
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById(valueId);
        
        if (!slider || !valueDisplay) {
            console.warn(`Could not find elements: slider=${sliderId}, value=${valueId}`);
            return;
        }
        
        valueDisplay.textContent = slider.value;
    }

    // Add this function after updateMusicState
    function updatePreviews() {
        lineTypes.forEach(lineType => {
            const previewElement = document.getElementById(`${lineType.id}-preview`);
            if (!previewElement) return;

            const lineData = currentLines.find(l => l.type.id === lineType.id);
            if (!lineData) {
                previewElement.innerHTML = '';
                return;
            }

            const notes = lineData.notes;
            if (notes.length === 0) {
                previewElement.innerHTML = '';
                return;
            }

            // Use ScoreUtilities.makePianoRollSVG instead of our JS implementation
            previewElement.innerHTML = ScoreUtilities.makePianoRollSVG(notes, 300, 150);
        });
    }
</script>

</body>
</html>
