<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GoldenPond</title>
    <style>
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .control-section {
            margin: 20px 0;
        }

        .line-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .part-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }

        .button-group {
            margin: 10px 0;
        }

        .button-group button {
            padding: 8px 16px;
            margin-right: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 1000px) {
            .line-controls-grid {
                grid-template-columns: 1fr;
            }
        }

        .line-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .preview-column {
            background: white;
            padding: 10px;
            border-radius: 3px;
        }

        .piano-roll-preview {
            width: 300px;
            height: 150px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .pattern-input {
            width: 100%;
            padding: 5px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-family: monospace;
        }

        .slider-group {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .root-mode-section {
            margin: 20px 0;
        }

        .root-mode-container {
            display: flex;
            gap: 20px;
        }

        .root-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mode-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .root-control input[type="range"] {
            width: 200px;
        }

        .mode-control select {
            width: 100px;
        }

        .root-control span {
            text-align: center;
        }

        .root-control span#rootNoteName {
            font-size: 1em;
        }

        .chord-names-section {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        .chord-names-section h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
        }
        
        .chord-names-section p {
            margin: 0;
            font-family: monospace;
        }

        .strudel-code-section {
            margin-top: 10px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            font-family: monospace;
        }
        
        .strudel-code-section pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .strudel-code-section code {
            font-size: 0.9em;
            line-height: 1.4;
        }
    </style>
    <link rel="stylesheet" href="styles.css">
    
    <!-- First load Soundfont player -->
    <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
    
    <!-- Then load goldenpond -->
    <script src="./goldenpond.js"></script>


    <!-- Add this after the other script tags in the head section -->
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
</head>
<body>
  <div class="transport-panel">
    <div class="button-group">
      <button onclick="play()">Play</button>
      <button onclick="stop()">Stop</button>
      <button onclick="downloadMidi()">Download MIDI</button>
      <button onclick="downloadSummary()">Download Summary</button>
      <button onclick="downloadProjectJSON()">Download Project JSON</button>
    </div>
  </div>
  <div class="container">
    <h2>GoldenPond</h2>

    <!-- Root and Mode Section -->
    <div class="control-section root-mode-section">
        <div class="root-mode-container">
            <div class="control-group root-control">
                <label for="root">Root: <span id="rootNoteName">60 (C4)</span></label> 
                <input type="range" id="root" name="root" min="32" max="96" value="60" style="width: 200px;">
                
            </div>
            <div class="control-group mode-control">
                <label for="mode">Mode:</label>
                <select id="mode" style="width: 100px;">
                    <option value="0">Major</option>
                    <option value="1">Minor</option>
                    <option value="2">Harmonic Minor</option>
                    <option value="3">Melodic Minor</option>
                </select>
            </div>

            <div class="control-group">
                <label for="chordLength">Chord Duration <span id="chordLengthValue">8</span></label>
                <input type="range" id="chordLength" name="chordLength" min="1" max="16" value="8">
                
            </div>

            <div class="control-group">
                <label for="bpm">Tempo (BPM):</label>
                <input type="range" id="bpm" name="bpm" min="40" max="200" value="120">
                <span id="bpmValue">120</span>
            </div>
    
        </div>
    </div>

    <!-- Chord Sequence -->
    <div class="control-section">
        <label for="chordSequence">Chord Sequence:</label><br>
        <textarea id="chordSequence" rows="4" cols="50">1,4,5,1</textarea>
        <div class="help-text" style="margin-top: 5px; font-size: 0.9em; color: #666;">
            <p>Example progressions:</p>
            <ul style="margin-top: 5px; padding-left: 20px;">
                <li>Basic Major : <code>1,4,5,1</code></li>
                <li>Extended pop progression : <code>1,5,-6,4,5</code></li>
                <li>Jazz sevenths ii-V-I-vi <code>72,75,71,76</code></li>
                <li>Key Transpositions : <code>71,>1,72,75,<1,71,>3,72,75,71</code></li>
                <li>Longer progression with mode switching : <code>76,72,75,71,!m,76,72,75,71,>2,!hm,76,72,75,71,!m,76,72,75,71</code></li>
                <li>Complex progression with secondary dominants : <code>71,74,-94,73,9(5/2),72,-75,91,!m,71,74,-94,73,9(5/2),72,-75,-95,!hm,71</code></li>
                <li>Modal harmony example : <code>7(6!4),7(2!4),7(5!4),7(1!4) </code> (this plays the 6-2-5-1 chord progression in the 4th mode (lydian) of the major scale</li>
            </ul>
        </div>
        <div id="chordNames" class="chord-names-section"></div>
    </div>

    <!-- Generate Types Section -->
    <div class="control-section">
        <h3>Patterns:</h3>
        <div id="line-controls"></div>
    </div>

    <!-- Strudel Code Section -->
    <div class="control-section" style="display: none;">
        <h3>Strudel Code:</h3>
        <div id="strudelCode" class="strudel-code-section">
            <pre><code></code></pre>
        </div>
    </div>

    <br>
  </div>
<script>
    console.log('Start of main script, goldenpond =', typeof goldenpond);
    
    // Global variables
    let domLoaded = false;
    let instrumentsLoaded = false;
    let tm = null;
    let prog = null;
    let audioContext = null;
    let chord_instrument, arp_instrument, bass_instrument, top_instrument, random_instrument;
    let currentLines = [];
    let currentTimeManipulator = null;
    let currentProgression = null;
    let instruments = {};
    let currentConfig = null;
    let projectData = null;  // Will be created when needed

    // Function to ensure projectData exists
    function ensureProjectData() {
        if (!projectData) {
            projectData = new GoldenData();
            // Initialize with current DOM values
            projectData.root = parseInt(document.getElementById('root').value);
            projectData.mode = parseInt(document.getElementById('mode').value);
            projectData.chordSequence = document.getElementById('chordSequence').value;
            projectData.bpm = parseInt(document.getElementById('bpm').value);
            projectData.chordDuration = parseInt(document.getElementById('chordLength').value);
        }
        return projectData;
    }

    // Function to initialize audio after user gesture
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            tm = new TimeManipulator();
            loadInstruments();
        }
    }

    // Add loading indicator
    function showLoading(show) {
        document.querySelectorAll('button').forEach(button => {
            button.disabled = show;
        });
        if (show) {
            document.querySelector('.button-group').insertAdjacentHTML('beforeend', 
                '<span id="loading-text"> Loading sounds...</span>');
        } else {
            document.getElementById('loading-text')?.remove();
        }
    }

    // Function to create all line controls
    function createAllLineControls(config) {
        const container = document.getElementById('line-controls');
        container.innerHTML = ''; // Clear existing controls
        
        Object.entries(config.lines).forEach(([lineId, settings]) => {
            const lineType = {
                id: lineId,
                name: getInstrumentName(lineId),  // Get instrument name instead of just capitalizing
                ...settings  // This spreads all settings including gateLength
            };
            const controls = createLineControls(lineType);
            container.appendChild(controls);
        });
    }

    // Helper function to get instrument name
    function getInstrumentName(lineId) {
        const instrumentNames = {
            'chords': 'Piano',
            'arpeggio': 'Harp',
            'bass': 'Bass',
            'top': 'Flute',
            'random': 'Tuba'
        };
        return instrumentNames[lineId] || lineId.charAt(0).toUpperCase() + lineId.slice(1);
    }

    // Add this function before createAllLineControls
    function createLineControls(lineType) {
        const section = document.createElement('div');
        section.className = 'line-controls';

        // Controls column
        const controlsColumn = document.createElement('div');
        controlsColumn.className = 'controls-column';

        // Active checkbox with instrument name
        const activeLabel = document.createElement('label');
        const activeCheckbox = document.createElement('input');
        activeCheckbox.type = 'checkbox';
        activeCheckbox.id = `${lineType.id}-active`;
        activeCheckbox.checked = lineType.checked;
        activeLabel.appendChild(activeCheckbox);
        activeLabel.appendChild(document.createTextNode(` ${lineType.name}`));
        controlsColumn.appendChild(activeLabel);

        // Pattern text input
        const patternLabel = document.createElement('label');
        patternLabel.textContent = 'Pattern:';
        patternLabel.htmlFor = `${lineType.id}-pattern`;
        controlsColumn.appendChild(patternLabel);
        
        const patternInput = document.createElement('input');
        patternInput.type = 'text';
        patternInput.id = `${lineType.id}-pattern`;
        patternInput.className = 'pattern-input';
        
        // Set default pattern based on line type
        let defaultPattern = '';
        switch(lineType.id) {
            case 'chords':
                defaultPattern = `${lineType.defaultK}/${lineType.defaultN} c 4`;
                break;
            case 'arpeggio':
                defaultPattern = `${lineType.defaultK}/${lineType.defaultN} > 4`;
                break;
            case 'bass':
                defaultPattern = `${lineType.defaultK}/${lineType.defaultN} 1 4`;
                break;
            case 'top':
                defaultPattern = `${lineType.defaultK}/${lineType.defaultN} t 4`;
                break;
            case 'random':
                defaultPattern = `${lineType.defaultK}%${lineType.defaultN} r 4`;
                break;
        }
        patternInput.value = defaultPattern;
        patternInput.addEventListener('change', updateControls);
        controlsColumn.appendChild(patternInput);

        // Add a small help text for pattern syntax
        const helpText = document.createElement('div');
        helpText.className = 'help-text';
        helpText.innerHTML = 'Examples: "3/8 c 4", "5%8 > 4", ">.>.=.<. 4"';
        helpText.style.fontSize = '0.8em';
        helpText.style.color = '#666';
        helpText.style.marginTop = '2px';
        controlsColumn.appendChild(helpText);

        // Add octave transpose slider
        const octaveContainer = document.createElement('div');
        octaveContainer.className = 'slider-group';
        
        const octaveLabel = document.createElement('div');
        octaveLabel.className = 'slider-label';
        octaveLabel.innerHTML = `Octave: <span id="${lineType.id}-octave-value">0</span>`;
        
        const octaveSlider = document.createElement('input');
        octaveSlider.type = 'range';
        octaveSlider.id = `${lineType.id}-octave`;
        octaveSlider.min = '-2';
        octaveSlider.max = '2';
        octaveSlider.value = '0';
        octaveSlider.step = '1';
        
        octaveSlider.oninput = () => {
            const value = parseInt(octaveSlider.value);
            document.getElementById(`${lineType.id}-octave-value`).textContent = value;
            updateControls();
        };
        
        octaveContainer.appendChild(octaveLabel);
        octaveContainer.appendChild(octaveSlider);
        controlsColumn.appendChild(octaveContainer);

        // Gate Length slider
        const gateLengthContainer = document.createElement('div');
        gateLengthContainer.className = 'slider-group';
        
        const gateLengthLabel = document.createElement('div');
        gateLengthLabel.className = 'slider-label';
        gateLengthLabel.innerHTML = `Gate Length: <span id="${lineType.id}-gateLength-value">${lineType.gateLength.toFixed(2)}</span>`;
        
        const gateLengthSlider = document.createElement('input');
        gateLengthSlider.type = 'range';
        gateLengthSlider.id = `${lineType.id}-gateLength`;
        gateLengthSlider.min = '0.1';
        gateLengthSlider.max = '1.0';
        gateLengthSlider.step = '0.1';
        gateLengthSlider.value = lineType.gateLength;
        
        gateLengthSlider.oninput = () => {
            const value = parseFloat(gateLengthSlider.value);
            document.getElementById(`${lineType.id}-gateLength-value`).textContent = value.toFixed(2);
            updateControls();
        };
        
        gateLengthContainer.appendChild(gateLengthLabel);
        gateLengthContainer.appendChild(gateLengthSlider);
        controlsColumn.appendChild(gateLengthContainer);

        // Preview column
        const previewColumn = document.createElement('div');
        previewColumn.className = 'preview-column';
        
        const previewTitle = document.createElement('div');
        previewTitle.textContent = 'Preview';
        previewColumn.appendChild(previewTitle);

        const pianoRoll = document.createElement('div');
        pianoRoll.id = `${lineType.id}-preview`;
        pianoRoll.className = 'piano-roll-preview';
        previewColumn.appendChild(pianoRoll);

        // Add event listeners
        activeCheckbox.addEventListener('change', updateControls);

        // Combine columns
        section.appendChild(controlsColumn);
        section.appendChild(previewColumn);

        return section;
    }

    // Load the instruments asynchronously
    function loadInstruments() {
        showLoading(true);
        Promise.all([
            Soundfont.instrument(audioContext, 'acoustic_grand_piano'),
            Soundfont.instrument(audioContext, 'orchestral_harp'),
            Soundfont.instrument(audioContext, 'acoustic_bass'),
            Soundfont.instrument(audioContext, 'flute'),
            Soundfont.instrument(audioContext, 'tuba')
        ]).then(([piano, harp, bass, flute, tuba]) => {
            instruments = {
                'chords': piano,
                'arpeggio': harp,
                'bass': bass,
                'top': flute,
                'random': tuba
            };
            instrumentsLoaded = true;
            showLoading(false);
        }).catch(err => {
            console.error('Error loading instruments:', err);
            showLoading(false);
        });
    }

    // Function to update time and progression settings
    function updateTimeAndProgression() {
        if (!tm) return;
        
        const bpm = parseInt(document.getElementById('bpm').value);
        const beatsPerChord = parseInt(document.getElementById('chordLength').value);
        const root = parseInt(document.getElementById('root').value);
        const modeValue = parseInt(document.getElementById('mode').value);
        const chordSequence = document.getElementById('chordSequence').value;
        
        // Update project data
        ensureProjectData();
        projectData.root = root;
        projectData.mode = modeValue;
        projectData.chordSequence = chordSequence;
        projectData.bpm = bpm;
        projectData.chordDuration = beatsPerChord;
        
        // Update time manipulator
        currentTimeManipulator = new TimeManipulator();
        currentTimeManipulator.setPPQ(96)
            .setChordDuration(beatsPerChord)
            .setBPM(bpm);
        
        // Update all lines
        currentLines = [];
        Object.entries(currentConfig.lines).forEach(([lineId, settings], index) => {
            const values = getLineValues(lineId);
            if (values.active) {
                // Create MidiInstrumentContext for this line
                const instrumentContext = new MidiInstrumentContext(
                    index,  // channel
                    100,    // velocity
                    values.gateLength,  // gate length
                    values.octave * 12  // transpose (convert octaves to semitones)
                );
                
                // Add line to project data with instrument context
                projectData.addLine(values.pattern, instrumentContext);
                
                // Add to currentLines immediately
                currentLines.push({
                    type: { id: lineId, name: getInstrumentName(lineId) },
                    line: projectData.makeLineGenerator(projectData.lines.length - 1),
                    notes: projectData.makeLineGenerator(projectData.lines.length - 1).generateNotes(0)
                });
            }
        });
        
        console.log('Updated settings:', {
            bpm, beatsPerChord, root, 
            mode: modeValue,
            chordSequence
        });
    }

    // Function to update all music state
    function updateMusicState() {
        ensureProjectData();  // Create projectData if needed
        
        const bpm = parseInt(document.getElementById('bpm').value);
        const beatsPerChord = parseInt(document.getElementById('chordLength').value);
        const root = parseInt(document.getElementById('root').value);
        const modeValue = parseInt(document.getElementById('mode').value);
        const chordSequence = document.getElementById('chordSequence').value;
        
        // Update project data
        projectData.root = root;
        projectData.mode = modeValue;
        projectData.chordSequence = chordSequence;
        projectData.bpm = bpm;
        projectData.chordDuration = beatsPerChord;
        
        // Clear existing lines
        projectData.lines = [];
        
        // Update time manipulator
        currentTimeManipulator = new TimeManipulator();
        currentTimeManipulator.setPPQ(96)
            .setChordDuration(beatsPerChord)
            .setBPM(bpm);

        // Update all lines
        currentLines = [];
        Object.entries(currentConfig.lines).forEach(([lineId, settings], index) => {
            const values = getLineValues(lineId);
            if (values.active) {
                // Create MidiInstrumentContext for this line
                const instrumentContext = new MidiInstrumentContext(
                    index,  // channel
                    100,    // velocity
                    values.gateLength,  // gate length
                    values.octave * 12  // transpose (convert octaves to semitones)
                );
                
                // Add line to project data with instrument context
                projectData.addLine(values.pattern, instrumentContext);
                
                // Add to currentLines immediately
                currentLines.push({
                    type: { id: lineId, name: getInstrumentName(lineId) },
                    line: projectData.makeLineGenerator(projectData.lines.length - 1),
                    notes: projectData.makeLineGenerator(projectData.lines.length - 1).generateNotes(0)
                });
            }
        });

        // Update previews
        updatePreviews();
        
        // Update Strudel code
        updateStrudelCode();
        
        // Log if project data has changed
        if (projectData.hasChanged()) {
            console.log("Project updated:", projectData.toString());
        }
    }

    // Modify updateControls to use the global state
    function updateControls() {
        updateMusicState();
        // Rest of updateControls remains the same
    }

    // Modify play() to use the new note property access
    function play() {
        if (!audioContext) initAudio();
        
        if (!instrumentsLoaded) {
            console.warn('Instruments not loaded yet');
            return;
        }
        
        ensureProjectData();  // Create projectData if needed
        
        const bpm = parseInt(document.getElementById('bpm').value);
        const secondsPerBeat = 60.0 / bpm;
        const baseTime = audioContext.currentTime + 0.1;
        
        console.log('Playing lines:', currentLines.map(l => ({
            type: l.type.id,
            noteCount: l.notes.length,
            hasInstrument: !!instruments[l.type.id]
        })));
        
        currentLines.forEach(({type, notes}) => {
            const instrument = instruments[type.id];
            if (instrument) {
                console.log(`Playing ${type.name} with ${notes.length} notes`);
                notes.forEach(note => {
                    const startInSeconds = (note.getStartTime() / currentTimeManipulator.ppq) * secondsPerBeat;
                    const durationInSeconds = (note.getLength() / currentTimeManipulator.ppq) * secondsPerBeat;
                    instrument.play(note.getMidiNoteValue(), baseTime + startInSeconds, { duration: durationInSeconds });
                });
            } else {
                console.warn(`No instrument found for ${type.name} (id: ${type.id})`);
            }
        });
    }

    // Define instrument mappings
    const INSTRUMENT_PROGRAMS = {
        'chords': 0,    // Acoustic Grand Piano
        'bass': 32,     // Acoustic Bass
        'top': 73,      // Flute
        'arp': 46,      // Harp
        'random': 25    // Acoustic Guitar
    };

    function downloadMidi() {
        console.log('Starting MIDI export with Tone.js...');
        
        // Create a new MIDI file
        const midi = new Midi();
        const bpm = parseInt(document.getElementById('bpm').value);
        const secondsPerBeat = 60.0 / bpm;
        
        midi.header.setTempo(bpm);
        midi.header.timeSignature = [4, 4];
        midi.header.ppq = currentTimeManipulator.ppq;

        // Add tracks for each line
        currentLines.forEach(({type, line}, index) => {
            const track = midi.addTrack();
            
            // Set instrument and channel
            track.channel = index;
            track.instrument.number = INSTRUMENT_PROGRAMS[type.id] || 0;
            
            // Get notes with absolute timing
            const notes = line.generateNotes(0);
            
            // Add notes to track
            notes.forEach(note => {
                track.addNote({
                    midi: note.getMidiNoteValue(),
                    time: (note.getStartTime() / currentTimeManipulator.ppq) * secondsPerBeat,
                    duration: (note.getLength() / currentTimeManipulator.ppq) * secondsPerBeat,
                    velocity: note.velocity
                });
            });
        });

        // Convert to MIDI file and download
        const bytes = midi.toArray();
        const blob = new Blob([new Uint8Array(bytes)], { type: 'audio/midi' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'goldenpond.mid';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Modify download functions to ensure projectData exists
    function downloadSummary() {
        ensureProjectData();  // Create projectData if needed
        const blob = new Blob([projectData.toString()], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'goldenpond-project.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function downloadProjectJSON() {
        ensureProjectData();  // Create projectData if needed
        const blob = new Blob([projectData.toJSON()], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'goldenpond-project.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Load a default piece when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // First create all the controls
        createAllLineControls(pieces.simpleMajor);
        console.log('Line controls created successfully');
        
        // Add event listeners for global controls
        ['root', 'chordLength', 'bpm'].forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Could not find element with id: ${id}`);
                return;
            }
            element.addEventListener('input', function() {
                updateDisplayValue(id, `${id}Value`);
                if (id === 'root') {
                    updateChordNames();
                }
            });
        });
        
        // Add handlers for time and progression updates
        ['bpm', 'chordLength', 'root', 'mode', 'chordSequence'].forEach(id => {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Could not find element with id: ${id}`);
                return;
            }
            element.addEventListener('change', function() {
                updateTimeAndProgression();
                updateControls();
                if (id === 'root' || id === 'mode' || id === 'chordSequence') {
                    updateChordNames();
                }
            });
        });

        // Add input event listener for chord sequence changes
        document.getElementById('chordSequence').addEventListener('input', updateChordNames);
        
        // Add change event listener for mode changes
        document.getElementById('mode').addEventListener('change', updateChordNames);

        console.log('All event listeners attached successfully');

        // Now that all DOM elements and event listeners are set up,
        // we can safely load the piece config
        setTimeout(() => {
            loadPieceConfig(pieces.simpleMajor);
        }, 0);
    });

    // Get values for a line type
    function getLineValues(lineId) {
        const values = {
            active: document.getElementById(`${lineId}-active`).checked,
            pattern: document.getElementById(`${lineId}-pattern`).value,
            volume: 0.8,  // Default volume
            octave: parseInt(document.getElementById(`${lineId}-octave`).value),
            gateLength: parseFloat(document.getElementById(`${lineId}-gateLength`).value)
        };
        return values;
    }

    // Add variable to track scheduled notes
    let scheduledNotes = [];
    
    // Add stop function
    function stop() {
        if (!audioContext) return;
        
        // Stop all active instruments
        Object.values(instruments).forEach(instrument => {
            if (instrument && typeof instrument.stop === 'function') {
                instrument.stop(audioContext.currentTime);
            }
        });
        
        // Clear scheduled notes
        scheduledNotes = [];
    }

    function updateDisplayValue(sliderId, valueId) {
        console.log(`Updating display value: ${sliderId} -> ${valueId}`);
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById(valueId);
        
        if (!slider || !valueDisplay) {
            console.warn(`Could not find elements: slider=${sliderId}, value=${valueId}`);
            return;
        }
        
        valueDisplay.textContent = slider.value;
    }

    // Update the updatePreviews function
    function updatePreviews() {
        Object.keys(currentConfig.lines).forEach(lineId => {
            const previewElement = document.getElementById(`${lineId}-preview`);
            if (!previewElement) return;

            const lineData = currentLines.find(l => l.type.id === lineId);
            if (!lineData) {
                previewElement.innerHTML = '';
                return;
            }

            const notes = lineData.notes;
            if (notes.length === 0) {
                previewElement.innerHTML = '';
                return;
            }

            const rect = previewElement.getBoundingClientRect();
            previewElement.innerHTML = ScoreUtilities.makePianoRollSVG(notes, rect.width, rect.height);
        });
    }

    // Add root note name update:
    document.getElementById('root').addEventListener('input', function() {
        const rootValue = parseInt(this.value);
        
        document.getElementById('rootNoteName').textContent = getMidiNoteName(rootValue);
        updateControls();
    });

    // Add note name calculation function:
    function getMidiNoteName(midiNumber) {
        const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
        const note = notes[midiNumber % 12];
        const octave = Math.floor(midiNumber / 12) - 1;
        return `${midiNumber} (${note}${octave})`;
    }

    // Update loadPieceConfig to store the current config
    function loadPieceConfig(config) {
        currentConfig = config;  // Store current configuration
        createAllLineControls(config);
        
        // Then set all the values
        document.getElementById('root').value = config.root;
        document.getElementById('mode').value = config.mode;
        document.getElementById('bpm').value = config.bpm;
        document.getElementById('chordLength').value = config.chordLength;

        document.getElementById('chordSequence').value = config.chordSequence;
        
        // Update displays
        updateDisplayValue('bpm', 'bpmValue');
        updateDisplayValue('chordLength', 'chordLengthValue');
        document.getElementById('rootNoteName').textContent = getMidiNoteName(config.root);
        
        // Update chord names display
        updateChordNames();
        
        // Set line controls
        Object.entries(config.lines).forEach(([lineId, settings]) => {
            document.getElementById(`${lineId}-active`).checked = settings.active;
            document.getElementById(`${lineId}-pattern`).value = settings.pattern;
            document.getElementById(`${lineId}-octave`).value = settings.octave;
            document.getElementById(`${lineId}-gateLength`).value = settings.gateLength;
            
            // Update displays
            document.getElementById(`${lineId}-octave-value`).textContent = settings.octave;
            document.getElementById(`${lineId}-gateLength-value`).textContent = settings.gateLength.toFixed(2);
        });
        
        // Update everything
        updateControls();
    }

    // Example piece configurations
    const pieces = {
        simpleMajor: {
            root: 60,
            mode: 0,
            bpm: 120,
            chordLength: 8,
            noteProportion: 0.8,
            chordSequence: "1,4,5,1",
            lines: {
                chords: { 
                    active: true, 
                    pattern: "1/4 c 4",
                    octave: 0,
                    gateLength: 0.8,
                    defaultK: 1,
                    defaultN: 4
                },
                arpeggio: { 
                    active: true, 
                    pattern: "3/4 > 4",
                    octave: 0,
                    gateLength: 0.5,
                    defaultK: 3,
                    defaultN: 4
                },
                bass: { 
                    active: true, 
                    pattern: "1/2 1 4",
                    octave: -1,
                    gateLength: 0.8,
                    defaultK: 1,
                    defaultN: 2
                },
                top: { 
                    active: false, 
                    pattern: "3/8 t 4",
                    octave: 1,
                    gateLength: 0.6,
                    defaultK: 3,
                    defaultN: 8
                },
                random: { 
                    active: false, 
                    pattern: "4%12 r 4",
                    octave: 0,
                    gateLength: 0.4,
                    defaultK: 4,
                    defaultN: 12
                }
            }
        },
        jazzWaltz: {
            root: 65,
            mode: 0,
            bpm: 160,
            chordLength: 3,
            noteProportion: 0.7,
            chordSequence: "72,75,71,74",
            lines: {
                chords: { 
                    active: true, 
                    pattern: "1/3 c 4",
                    octave: 0,
                    gateLength: 0.9,
                    defaultK: 1,
                    defaultN: 3
                },
                arpeggio: { 
                    active: true, 
                    pattern: "2/3 > 4",
                    octave: 1,
                    gateLength: 0.4,
                    defaultK: 2,
                    defaultN: 3
                },
                bass: { 
                    active: true, 
                    pattern: "1/3 1 4",
                    octave: -1,
                    gateLength: 0.7,
                    defaultK: 1,
                    defaultN: 3
                },
                top: { 
                    active: true, 
                    pattern: "2/6 t 4",
                    octave: 1,
                    gateLength: 0.6,
                    defaultK: 2,
                    defaultN: 6
                },
                random: { 
                    active: false, 
                    pattern: "3%6 r 4",
                    octave: 0,
                    gateLength: 0.3,
                    defaultK: 3,
                    defaultN: 6
                }
            }
        }
    };

    // Add MIDI note to note name conversion
    function midiToNoteName(midiNote) {
        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const note = notes[midiNote % 12];
        const octave = Math.floor(midiNote / 12) - 1;
        return note + octave;
    }

    // Add function to update chord names display
    function updateChordNames() {
        const chordSequence = document.getElementById('chordSequence').value;
        const chordNamesDiv = document.getElementById('chordNames');
        
        try {
            const progression = new ChordProgression(
                parseInt(document.getElementById('root').value),
                document.getElementById('mode').value == "0" ? Mode.getMajorMode() : Mode.getMinorMode(),
                chordSequence
            );
            
            // Use the ChordProgression's getChordNames method directly
            const chordNames = progression.getChordNames();
            
            chordNamesDiv.innerHTML = "<h3>Chord Names:</h3><p>" + chordNames.join(" â†’ ") + "</p>";
        } catch (error) {
            chordNamesDiv.innerHTML = "<p style='color: red;'>Error parsing chord sequence: " + error.message + "</p>";
        }
    }

    // Add function to convert notes to Strudel pattern
    function notesToStrudelPattern(notes, lineType) {
        if (!notes || notes.length === 0) return '';
        
        // Get the pattern
        const pattern = document.getElementById(`${lineType.id}-pattern`).value;
        const chordDuration = parseInt(document.getElementById('chordLength').value);
        
        // Create the base pattern using the rhythm pattern
        let strudelPattern = `note(\`<`;
        
        // Add the pattern
        strudelPattern += `[${notes[0].note}](${pattern})`;
        
        // Add rests to fill the chord duration
        strudelPattern += ` [~@${chordDuration - 1}]`;
        
        strudelPattern += `>\`)`;
        
        // Add sound based on line type
        const soundMap = {
            'chords': 'piano',
            'arpeggio': 'harp',
            'bass': 'bass',
            'top': 'flute',
            'random': 'tuba'
        };
        strudelPattern += `.sound("${soundMap[lineType.id] || 'piano'}")`;
        
        // Add gain based on velocity if available
        if (notes[0].velocity !== undefined) {
            const avgVelocity = notes.reduce((sum, note) => sum + note.velocity, 0) / notes.length;
            strudelPattern += `.gain(${avgVelocity / 127})`;
        }

        // Add pattern to sequence notes
        strudelPattern += `.seq()`;
        
        return strudelPattern;
    }

    // Add function to update Strudel code display
    function updateStrudelCode() {
        const strudelCodeDiv = document.getElementById('strudelCode');
        if (!currentLines || currentLines.length === 0) {
            strudelCodeDiv.querySelector('code').textContent = '// No lines active';
            return;
        }

        let code = '';
        
        // Convert BPM to CPM (1 cycle = 1 beat)
        const bpm = parseInt(document.getElementById('bpm').value);
        code += `var cpm = ${bpm};\n\n`;
        
        // Add each line's pattern
        currentLines.forEach(({type, notes}) => {
            if (notes && notes.length > 0) {
                code += `// ${type.name} line\n`;
                code += `const ${type.id}Pattern = ${notesToStrudelPattern(notes, type)};\n\n`;
            }
        });
        
        // Add the final pattern combination using stack()
        code += 'stack(\n';
        code += currentLines
            .filter(({notes}) => notes && notes.length > 0)
            .map(({type}) => `  ${type.id}Pattern`)
            .join(',\n');
        code += '\n).cpm(cpm);\n';
        
        strudelCodeDiv.querySelector('code').textContent = code;
    }
</script>

</body>
</html>
