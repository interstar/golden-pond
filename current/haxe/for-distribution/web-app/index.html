<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GoldenPond</title>
    <style>
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .control-section {
            margin: 20px 0;
        }

        .line-controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .part-section {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
        }

        .button-group {
            margin: 10px 0;
        }

        .button-group button {
            padding: 8px 16px;
            margin-right: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 1000px) {
            .line-controls-grid {
                grid-template-columns: 1fr;
            }
        }

        .line-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .preview-column {
            background: white;
            padding: 10px;
            border-radius: 3px;
        }

        .piano-roll-preview {
            width: 300px;
            height: 150px;
            background-color: #f8f8f8;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .slider-group {
            margin: 10px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .root-mode-section {
            margin: 20px 0;
        }

        .root-mode-container {
            display: flex;
            gap: 20px;
        }

        .root-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mode-control {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .root-control input[type="range"] {
            width: 200px;
        }

        .mode-control select {
            width: 100px;
        }

        .root-control span {
            text-align: center;
        }

        .root-control span#rootNoteName {
            font-size: 1em;
        }
    </style>
    <link rel="stylesheet" href="styles.css">
    
    <!-- First load Soundfont player -->
    <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
    
    <!-- Then load goldenpond -->
    <script src="./goldenpond.js"></script>


    <!-- Add this after the other script tags in the head section -->
    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi"></script>
</head>
<body>
  <div class="transport-panel">
    <div class="button-group">
      <button onclick="play()">Play</button>
      <button onclick="stop()">Stop</button>
      <button onclick="downloadMidi()">Download MIDI</button>
    </div>
  </div>
  <div class="container">
    <h2>GoldenPond</h2>

    <!-- Root and Mode Section -->
    <div class="control-section root-mode-section">
        <div class="root-mode-container">
            <div class="control-group root-control">
                <label for="root">Root: <span id="rootNoteName">65 (F4)</span></label> 
                <input type="range" id="root" name="root" min="32" max="96" value="65" style="width: 200px;">
                
            </div>
            <div class="control-group mode-control">
                <label for="mode">Mode:</label>
                <select id="mode" style="width: 100px;">
                    <option value="0">Major</option>
                    <option value="1">Minor</option>
                </select>
            </div>

            <div class="control-group">
                <label for="chordLength">Chord Duration (in quarter-notes): <span id="chordLengthValue">4</span></label>
                <input type="range" id="chordLength" name="chordLength" min="1" max="16" value="4">
                
            </div>

            <div class="control-group">
                <label for="bpm">Tempo (BPM):</label>
                <input type="range" id="bpm" name="bpm" min="40" max="200" value="120">
                <span id="bpmValue">120</span>
            </div>
    
        </div>
    </div>

    <!-- Chord Sequence -->
    <div class="control-section">
        <label for="chordSequence">Chord Sequence:</label><br>
        <textarea id="chordSequence" rows="4" cols="50">71,76,72,-75,71,76,72,-75i,77,73,76,<12,77ii,>12,71,96,74ii,75</textarea>
    </div>


    <!-- Add BPM control and play buttons -->
    <div class="control-section">
    </div>


    <!-- Generate Types Section -->
    <div class="control-section">
        <h3>Generate Types:</h3>
        <div id="line-controls"></div>
    </div>

    <br>
  </div>
<script>
    console.log('Start of main script, goldenpond =', typeof goldenpond);
    
    // Global variables
    let domLoaded = false;
    let instrumentsLoaded = false;
    let tm = null;
    let prog = null;
    let audioContext = null;
    let chord_instrument, arp_instrument, bass_instrument, top_instrument, random_instrument;
    let currentLines = [];
    let currentTimeManipulator = null;
    let currentProgression = null;
    let instruments = {};
    let currentConfig = null;

    // Function to initialize audio after user gesture
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            tm = new TimeManipulator();
            loadInstruments();
        }
    }

    // Add loading indicator
    function showLoading(show) {
        document.querySelectorAll('button').forEach(button => {
            button.disabled = show;
        });
        if (show) {
            document.querySelector('.button-group').insertAdjacentHTML('beforeend', 
                '<span id="loading-text"> Loading sounds...</span>');
        } else {
            document.getElementById('loading-text')?.remove();
        }
    }

    // Function to create all line controls
    function createAllLineControls(config) {
        const container = document.getElementById('line-controls');
        container.innerHTML = ''; // Clear existing controls
        
        Object.entries(config.lines).forEach(([lineId, settings]) => {
            const lineType = {
                id: lineId,
                name: lineId.charAt(0).toUpperCase() + lineId.slice(1),
                ...settings  // This spreads all settings including gateLength
            };
            const controls = createLineControls(lineType);
            container.appendChild(controls);
        });
    }

    // Add this function before createAllLineControls
    function createLineControls(lineType) {
        const section = document.createElement('div');
        section.className = 'line-controls';

        // Controls column
        const controlsColumn = document.createElement('div');
        controlsColumn.className = 'controls-column';

        // Active checkbox
        const activeLabel = document.createElement('label');
        const activeCheckbox = document.createElement('input');
        activeCheckbox.type = 'checkbox';
        activeCheckbox.id = `${lineType.id}-active`;
        activeCheckbox.checked = lineType.checked;
        activeLabel.appendChild(activeCheckbox);
        activeLabel.appendChild(document.createTextNode(` ${lineType.name}`));
        controlsColumn.appendChild(activeLabel);

        // Density dropdown
        const densityLabel = document.createElement('label');
        densityLabel.textContent = 'Density:';
        const densitySelect = document.createElement('select');
        densitySelect.id = `${lineType.id}-density`;
        MenuHelper.getRhythmicDensityNames().forEach((name, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.text = name;
            densitySelect.appendChild(option);
        });
        densitySelect.value = "4"; // Default to quarter notes
        controlsColumn.appendChild(densityLabel);
        controlsColumn.appendChild(densitySelect);

        // K and N sliders
        ['k', 'n'].forEach(param => {
            const sliderContainer = document.createElement('div');
            sliderContainer.className = 'slider-group';
            
            const sliderLabel = document.createElement('div');
            sliderLabel.className = 'slider-label';
            sliderLabel.innerHTML = `${param.toUpperCase()}: <span id="${lineType.id}-${param}-value">${lineType[`default${param.toUpperCase()}`]}</span>`;
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.id = `${lineType.id}-${param}`;
            slider.min = '1';
            slider.max = '24';
            slider.value = lineType[`default${param.toUpperCase()}`];
            
            slider.oninput = () => {
                document.getElementById(`${lineType.id}-${param}-value`).textContent = slider.value;
                updateControls();
            };
            
            sliderContainer.appendChild(sliderLabel);
            sliderContainer.appendChild(slider);
            controlsColumn.appendChild(sliderContainer);
        });

        // Add octave transpose slider after K and N sliders
        const octaveContainer = document.createElement('div');
        octaveContainer.className = 'slider-group';
        
        const octaveLabel = document.createElement('div');
        octaveLabel.className = 'slider-label';
        octaveLabel.innerHTML = `Octave: <span id="${lineType.id}-octave-value">0</span>`;
        
        const octaveSlider = document.createElement('input');
        octaveSlider.type = 'range';
        octaveSlider.id = `${lineType.id}-octave`;
        octaveSlider.min = '-2';
        octaveSlider.max = '2';
        octaveSlider.value = '0';
        octaveSlider.step = '1';
        
        octaveSlider.oninput = () => {
            const value = parseInt(octaveSlider.value);
            document.getElementById(`${lineType.id}-octave-value`).textContent = value;
            updateControls();
        };
        
        octaveContainer.appendChild(octaveLabel);
        octaveContainer.appendChild(octaveSlider);
        controlsColumn.appendChild(octaveContainer);

        // Gate Length slider
        const gateLengthContainer = document.createElement('div');
        gateLengthContainer.className = 'slider-group';
        
        const gateLengthLabel = document.createElement('div');
        gateLengthLabel.className = 'slider-label';
        gateLengthLabel.innerHTML = `Gate Length: <span id="${lineType.id}-gateLength-value">${lineType.gateLength.toFixed(2)}</span>`;
        
        const gateLengthSlider = document.createElement('input');
        gateLengthSlider.type = 'range';
        gateLengthSlider.id = `${lineType.id}-gateLength`;
        gateLengthSlider.min = '0.1';
        gateLengthSlider.max = '1.0';
        gateLengthSlider.step = '0.1';
        gateLengthSlider.value = lineType.gateLength;
        
        gateLengthSlider.oninput = () => {
            const value = parseFloat(gateLengthSlider.value);
            document.getElementById(`${lineType.id}-gateLength-value`).textContent = value.toFixed(2);
            updateControls();
        };
        
        gateLengthContainer.appendChild(gateLengthLabel);
        gateLengthContainer.appendChild(gateLengthSlider);
        controlsColumn.appendChild(gateLengthContainer);

        // Preview column
        const previewColumn = document.createElement('div');
        previewColumn.className = 'preview-column';
        
        const previewTitle = document.createElement('div');
        previewTitle.textContent = 'Preview';
        previewColumn.appendChild(previewTitle);

        const pianoRoll = document.createElement('div');
        pianoRoll.id = `${lineType.id}-preview`;
        pianoRoll.className = 'piano-roll-preview';
        previewColumn.appendChild(pianoRoll);

        // Add event listeners
        activeCheckbox.addEventListener('change', updateControls);
        densitySelect.addEventListener('change', updateControls);

        // Combine columns
        section.appendChild(controlsColumn);
        section.appendChild(previewColumn);

        return section;
    }

    // Load the instruments asynchronously
    function loadInstruments() {
        showLoading(true);
        Promise.all([
            Soundfont.instrument(audioContext, 'acoustic_grand_piano'),
            Soundfont.instrument(audioContext, 'orchestral_harp'),
            Soundfont.instrument(audioContext, 'acoustic_bass'),
            Soundfont.instrument(audioContext, 'flute'),
            Soundfont.instrument(audioContext, 'marimba')
        ]).then(([piano, harp, bass, flute, marimba]) => {
            instruments = {
                'chords': piano,
                'arpeggio': harp,
                'bass': bass,
                'top': flute,
                'random': marimba
            };
            instrumentsLoaded = true;
            showLoading(false);
        }).catch(err => {
            console.error('Error loading instruments:', err);
            showLoading(false);
        });
    }

    // Function to update time and progression settings
    function updateTimeAndProgression() {
        if (!tm) return;
        
        const bpm = parseInt(document.getElementById('bpm').value);
        const beatsPerChord = parseInt(document.getElementById('chordLength').value);
        const root = parseInt(document.getElementById('root').value);
        const mode = document.getElementById('mode').value == "0" ? 
            Mode.getMajorMode() : 
            Mode.getMinorMode();
        const chordSequence = document.getElementById('chordSequence').value;
        
        // Update TimeManipulator
        tm.setPPQ(96)
          .setChordDuration(beatsPerChord)
          .setBPM(bpm);
        
        // Update ChordProgression
        prog = new ChordProgression(root, mode, chordSequence);
        
        console.log('Updated settings:', {
            bpm, beatsPerChord, root, 
            mode: mode == Mode.getMajorMode() ? 'major' : 'minor',
            chordSequence
        });
    }

    // Function to update all music state
    function updateMusicState() {
        const bpm = parseInt(document.getElementById('bpm').value);
        const beatsPerChord = parseInt(document.getElementById('chordLength').value);
        
        // Update time manipulator
        currentTimeManipulator = new TimeManipulator();
        currentTimeManipulator.setPPQ(96)
            .setChordDuration(beatsPerChord)
            .setBPM(bpm);

        // Update progression
        currentProgression = new ChordProgression(
            parseInt(document.getElementById('root').value),
            document.getElementById('mode').value == "0" ? Mode.getMajorMode() : Mode.getMinorMode(),
            document.getElementById('chordSequence').value
        );

        // Update all lines
        currentLines = [];
        Object.entries(currentConfig.lines).forEach(([lineId, settings]) => {
            const values = getLineValues(lineId);
            if (values.active) {
                let line;
                switch(lineId) {
                    case 'chords':
                        line = new ChordLine(currentTimeManipulator, currentProgression, 
                            values.k, values.n, values.gateLength, values.density);
                        break;
                    case 'arpeggio':
                        line = new ArpLine(currentTimeManipulator, currentProgression, values.k, values.n, values.gateLength, values.density);
                        break;
                    case 'bass':
                        line = new BassLine(currentTimeManipulator, currentProgression, values.k, values.n, values.gateLength, values.density);
                        break;
                    case 'top':
                        line = new TopLine(currentTimeManipulator, currentProgression, values.k, values.n, values.gateLength, values.density);
                        break;
                    case 'random':
                        line = new RandomLine(currentTimeManipulator, currentProgression, values.k, values.n, values.gateLength, values.density);
                        break;
                }
                if (line) {
                    line.transpose(values.octave * 12);
                    currentLines.push({
                        type: { id: lineId, name: lineId.charAt(0).toUpperCase() + lineId.slice(1) },
                        line: line,
                        notes: line.generateNotes(0, 0, 100)
                    });
                }
            }
        });

        // Update previews
        updatePreviews();
    }

    // Modify updateControls to use the global state
    function updateControls() {
        updateMusicState();
        // Rest of updateControls remains the same
    }

    // Modify play() to use the global state
    function play() {
        if (!audioContext) initAudio();
        
        if (!instrumentsLoaded) {
            console.warn('Instruments not loaded yet');
            return;
        }
        
        const bpm = parseInt(document.getElementById('bpm').value);
        const secondsPerBeat = 60.0 / bpm;
        const baseTime = audioContext.currentTime + 0.1;
        
        console.log('Playing lines:', currentLines.map(l => ({
            type: l.type.id,
            noteCount: l.notes.length,
            hasInstrument: !!instruments[l.type.id]
        })));
        
        currentLines.forEach(({type, notes}) => {
            const instrument = instruments[type.id];
            if (instrument) {
                console.log(`Playing ${type.name} with ${notes.length} notes`);
                notes.forEach(note => {
                    const startInSeconds = (note.startTime / currentTimeManipulator.ppq) * secondsPerBeat;
                    const durationInSeconds = (note.length / currentTimeManipulator.ppq) * secondsPerBeat;
                    instrument.play(note.note, baseTime + startInSeconds, { duration: durationInSeconds });
                });
            } else {
                console.warn(`No instrument found for ${type.name} (id: ${type.id})`);
            }
        });
    }

    // Define instrument mappings
    const INSTRUMENT_PROGRAMS = {
        'chords': 0,    // Acoustic Grand Piano
        'bass': 32,     // Acoustic Bass
        'top': 73,      // Flute
        'arp': 46,      // Harp
        'random': 25    // Acoustic Guitar
    };

    function downloadMidi() {
        console.log('Starting MIDI export with Tone.js...');
        
        // Create a new MIDI file
        const midi = new Midi();
        const bpm = parseInt(document.getElementById('bpm').value);
        const secondsPerBeat = 60.0 / bpm;
        
        midi.header.setTempo(bpm);
        midi.header.timeSignature = [4, 4];
        midi.header.ppq = currentTimeManipulator.ppq;

        // Add tracks for each line
        currentLines.forEach(({type, line}, index) => {
            const track = midi.addTrack();
            
            // Set instrument and channel
            track.channel = index;
            track.instrument.number = INSTRUMENT_PROGRAMS[type.id] || 0;
            
            // Get notes with absolute timing
            const notes = line.generateNotes(0, index, 100);
            
            // Add notes to track
            notes.forEach(note => {
                track.addNote({
                    midi: note.note,
                    time: (note.startTime / currentTimeManipulator.ppq) * secondsPerBeat,
                    duration: (note.length / currentTimeManipulator.ppq) * secondsPerBeat,
                    velocity: note.velocity
                });
            });
        });

        // Convert to MIDI file and download
        const bytes = midi.toArray();
        const blob = new Blob([new Uint8Array(bytes)], { type: 'audio/midi' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'goldenpond.mid';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Modify the DOMContentLoaded handler
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded');
        domLoaded = true;
        
        try {
            // First create all the controls
            createAllLineControls(pieces.simpleMajor);
            console.log('Line controls created successfully');
            
            // Add event listeners for global controls
            ['root', 'chordLength', 'bpm'].forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Could not find element with id: ${id}`);
                    return;
                }
                element.addEventListener('input', function() {
                    updateDisplayValue(id, `${id}Value`);
                });
            });
            
            // Add handlers for time and progression updates
            ['bpm', 'chordLength', 'root', 'mode', 'chordSequence'].forEach(id => {
                const element = document.getElementById(id);
                if (!element) {
                    console.warn(`Could not find element with id: ${id}`);
                    return;
                }
                element.addEventListener('change', function() {
                    updateTimeAndProgression();
                    updateControls();
                });
            });

            console.log('All event listeners attached successfully');
        } catch (error) {
            console.error('Error during initialization:', error);
        }

        // Initialize audio on first user interaction
        document.body.addEventListener('click', function initOnClick() {
            initAudio();
            document.body.removeEventListener('click', initOnClick);
        });
    });

    // Get values for a line type
    function getLineValues(lineId) {
        const values = {
            active: document.getElementById(`${lineId}-active`).checked,
            density: MenuHelper.rhythmicDensityToNumeric(
                MenuHelper.getRhythmicDensityFor(document.getElementById(`${lineId}-density`).value)
            ),
            k: parseInt(document.getElementById(`${lineId}-k`).value),
            n: parseInt(document.getElementById(`${lineId}-n`).value),
            octave: parseInt(document.getElementById(`${lineId}-octave`).value),
            gateLength: parseFloat(document.getElementById(`${lineId}-gateLength`).value)
        };
        return values;
    }

    // Add variable to track scheduled notes
    let scheduledNotes = [];
    
    // Add stop function
    function stop() {
        if (!audioContext) return;
        
        // Stop all active instruments
        Object.values(instruments).forEach(instrument => {
            if (instrument && typeof instrument.stop === 'function') {
                instrument.stop(audioContext.currentTime);
            }
        });
        
        // Clear scheduled notes
        scheduledNotes = [];
    }

    function updateDisplayValue(sliderId, valueId) {
        console.log(`Updating display value: ${sliderId} -> ${valueId}`);
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById(valueId);
        
        if (!slider || !valueDisplay) {
            console.warn(`Could not find elements: slider=${sliderId}, value=${valueId}`);
            return;
        }
        
        valueDisplay.textContent = slider.value;
    }

    // Update the updatePreviews function
    function updatePreviews() {
        Object.keys(currentConfig.lines).forEach(lineId => {
            const previewElement = document.getElementById(`${lineId}-preview`);
            if (!previewElement) return;

            const lineData = currentLines.find(l => l.type.id === lineId);
            if (!lineData) {
                previewElement.innerHTML = '';
                return;
            }

            const notes = lineData.notes;
            if (notes.length === 0) {
                previewElement.innerHTML = '';
                return;
            }

            const rect = previewElement.getBoundingClientRect();
            previewElement.innerHTML = ScoreUtilities.makePianoRollSVG(notes, rect.width, rect.height);
        });
    }

    // Add root note name update:
    document.getElementById('root').addEventListener('input', function() {
        const rootValue = parseInt(this.value);
        
        document.getElementById('rootNoteName').textContent = getMidiNoteName(rootValue);
        updateControls();
    });

    // Add note name calculation function:
    function getMidiNoteName(midiNumber) {
        const notes = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
        const note = notes[midiNumber % 12];
        const octave = Math.floor(midiNumber / 12) - 1;
        return `${midiNumber} (${note}${octave})`;
    }

    // Update loadPieceConfig to store the current config
    function loadPieceConfig(config) {
        currentConfig = config;  // Store current configuration
        createAllLineControls(config);
        
        // Then set all the values
        document.getElementById('root').value = config.root;
        document.getElementById('mode').value = config.mode;
        document.getElementById('bpm').value = config.bpm;
        document.getElementById('chordLength').value = config.chordLength;

        document.getElementById('chordSequence').value = config.chordSequence;
        
        // Update displays
        updateDisplayValue('bpm', 'bpmValue');
        updateDisplayValue('chordLength', 'chordLengthValue');
        document.getElementById('rootNoteName').textContent = getMidiNoteName(config.root);
        
        // Set line controls
        Object.entries(config.lines).forEach(([lineId, settings]) => {
            document.getElementById(`${lineId}-active`).checked = settings.active;
            document.getElementById(`${lineId}-k`).value = settings.k;
            document.getElementById(`${lineId}-n`).value = settings.n;
            document.getElementById(`${lineId}-density`).value = settings.density;
            document.getElementById(`${lineId}-octave`).value = settings.octave;
            document.getElementById(`${lineId}-gateLength`).value = settings.gateLength;
            
            // Update displays
            document.getElementById(`${lineId}-k-value`).textContent = settings.k;
            document.getElementById(`${lineId}-n-value`).textContent = settings.n;
            document.getElementById(`${lineId}-octave-value`).textContent = settings.octave;
            document.getElementById(`${lineId}-gateLength-value`).textContent = settings.gateLength.toFixed(2);
        });
        
        // Update everything
        updateControls();
    }

    // Example piece configurations
    const pieces = {
        simpleMajor: {
            root: 60,
            mode: 0,
            bpm: 120,
            chordLength: 4,
            noteProportion: 0.8,
            chordSequence: "1,4,5,1",
            lines: {
                chords: { 
                    active: true, 
                    k: 1, 
                    n: 4, 
                    density: 7,
                    octave: 0,
                    gateLength: 0.8
                },
                arpeggio: { 
                    active: true, 
                    k: 3, 
                    n: 4, 
                    density: 6,
                    octave: 0,
                    gateLength: 0.5
                },
                bass: { 
                    active: true, 
                    k: 1, 
                    n: 2, 
                    density: 6,
                    octave: -1,
                    gateLength: 0.8
                },
                top: { 
                    active: false, 
                    k: 3, 
                    n: 8, 
                    density: 6,
                    octave: 1,
                    gateLength: 0.6
                },
                random: { 
                    active: false, 
                    k: 4, 
                    n: 12, 
                    density: 6,
                    octave: 0,
                    gateLength: 0.4
                }
            }
        },
        jazzWaltz: {
            root: 65,
            mode: 0,
            bpm: 160,
            chordLength: 3,
            noteProportion: 0.7,
            chordSequence: "72,75,71,74",
            lines: {
                chords: { 
                    active: true, 
                    k: 1, 
                    n: 3, 
                    density: 6,
                    octave: 0,
                    gateLength: 0.9
                },
                arpeggio: { 
                    active: true, 
                    k: 2, 
                    n: 3, 
                    density: 2,
                    octave: 1,
                    gateLength: 0.4
                },
                bass: { 
                    active: true, 
                    k: 1, 
                    n: 3, 
                    density: 4,
                    octave: -1,
                    gateLength: 0.7
                },
                top: { 
                    active: true, 
                    k: 2, 
                    n: 6, 
                    density: 4,
                    octave: 1,
                    gateLength: 0.6
                },
                random: { 
                    active: false, 
                    k: 3, 
                    n: 6, 
                    density: 2,
                    octave: 0,
                    gateLength: 0.3
                }
            }
        }
    };

    // Load a default piece when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        createAllLineControls(pieces.simpleMajor);
        loadPieceConfig(pieces.simpleMajor);
    });
</script>

</body>
</html>
